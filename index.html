<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ArkSIM Pro</title>
  <style>
    :root{
      --bg:#0b0c10; --panel:#191c23; --panel2:#20242c; --text:#e5e7eb; --muted:#9aa0aa;
      --accent:#4BA3F2; --grid:#2a2d36; --card:#0f1014; --glow:#4BA3F2;
      --scroll-track:#0d0e12; --scroll-thumb:#303441; --scroll-thumb-hover:#4BA3F2;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,sans-serif}
    .app{display:grid;grid-template-columns:280px 280px 1fr 280px;grid-template-rows:1fr auto;gap:16px;padding:16px;height:100vh;padding-bottom:16px}
    @supports (height: 100dvh){ .app{height:100dvh} }
    .panel{background:linear-gradient(135deg,var(--panel),var(--panel2));border:1px solid #20222b;border-radius:14px;padding:14px;box-shadow:0 8px 24px rgba(0,0,0,.35)}
    .title{font-weight:700;font-size:13px;margin-bottom:12px;text-transform:uppercase;letter-spacing:.5px;color:var(--muted)}
    /* Chart */
    .chart-container{grid-column:3 / 5;grid-row:1;display:flex;flex-direction:column;gap:12px}
    .chart-panel{flex:1;background:linear-gradient(180deg,#0d0f14,#0b0c10);border:1px solid #1d1f27;border-radius:14px;padding:16px;position:relative;overflow:hidden}
    .chart-top{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .chart-top .select{max-width:200px}
    .chart{width:100%;height:100%;min-height:420px}
    .legend{display:flex;flex-wrap:wrap;gap:12px;padding:12px;background:var(--panel);border:1px solid #20222b;border-radius:10px;font-size:11px}
    .legend-item{display:flex;align-items:center;gap:6px;cursor:pointer;position:relative}
    .legend-item input[type="checkbox"]{width:14px;height:14px}
    .legend-dot{width:8px;height:8px;border-radius:50%}
    .legend-name{user-select:none}
    .tooltip{position:absolute;bottom:100%;left:0;margin-bottom:8px;background:#0d0e12;border:1px solid #2a2d36;border-radius:8px;padding:10px;min-width:220px;opacity:0;pointer-events:none;transform:translateY(5px);transition:.2s;z-index:1000;box-shadow:0 8px 24px rgba(0,0,0,.5)}
    .legend-item:hover .tooltip{opacity:1;transform:translateY(0)}
    .tooltip-row{display:flex;justify-content:space-between;padding:2px 0;font-size:10px}
    .tooltip-label{color:var(--muted)}
    .tooltip-value{color:var(--text);font-weight:600}
    /* Bottom row */
    .bottom-grid{grid-column:2 / 5;grid-row:2;display:grid;grid-template-columns:1fr 1fr;gap:16px;grid-auto-rows:minmax(180px, auto);margin-bottom:12px}
    @media (max-width: 1200px){.bottom-grid{grid-template-columns:1fr}}
    @media (max-height: 820px){ .bottom-grid{grid-template-columns:1fr} }
    .stats-grid{display:grid;grid-template-columns:1fr 1fr;column-gap:20px;row-gap:12px;align-content:start}
    @media (max-width: 1200px){.stats-grid{grid-template-columns:1fr}}
    /* Controls + sliders */
    .control{margin-bottom:10px;padding:8px;background:var(--card);border:1px solid #1f2129;border-radius:8px}
    .control label{display:flex;align-items:center;justify-content:space-between;font-size:11px;font-weight:500;margin-bottom:6px;color:var(--text)}
    .value-bubble{padding:2px 6px;border-radius:12px;font-size:10px;background:#0d0e12;border:1px solid #2a2d36;color:var(--accent);font-weight:600}
    input[type=range]{-webkit-appearance:none;width:100%;height:4px;border-radius:4px;background:#2a2d36;outline:none}
    input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;background:var(--accent);border-radius:50%;border:2px solid #0d0e12;cursor:pointer;transition:.2s}
    input[type=range]::-webkit-slider-thumb:hover{box-shadow:0 0 0 4px rgba(75,163,242,.2)}
    .select,select{width:100%;background:#0d0e12;color:var(--text);border:1px solid #2a2d36;border-radius:6px;padding:6px;font-size:11px}
    .btn{cursor:pointer;background:#0d0e12;border:1px solid #2a2d36;color:var(--text);border-radius:6px;padding:6px 10px;font-size:11px;transition:.2s}
    .btn:hover{border-color:var(--accent);background:#1a1b22}
    .scale-labels{margin:-2px 0 6px 0;font-size:10px!important;line-height:1.2;color:var(--muted);letter-spacing:.2px;font-weight:400}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid #2a2d36;border-radius:999px;background:#0d0e12;font-size:10px}
    .small{font-size:10px;color:var(--muted)}
    .rank-badge{width:20px;height:20px;display:inline-flex;align-items:center;justify-content:center;border-radius:999px;background:#0d0e12;border:1px solid #2a2d36;color:var(--muted);font-size:11px;font-weight:700;flex:0 0 20px}
    /* Lika stora kontrollfönster i Makro och Strategi */
    .top-controls .control{min-height:72px;display:flex;flex-direction:column;justify-content:space-between;padding:10px 12px;margin-bottom:6px}
    .top-controls .control .scale-labels{min-height:10px;margin:-2px 0 2px 0}
    .top-controls .title{margin-bottom:8px}
    /* Intern scroll för toppanelerna + korrekt krymp i grid */
    .app > .panel{min-height:0}
    .top-controls{overflow:auto;-webkit-overflow-scrolling:touch}
    .chart-container{min-height:0}
    /* Responsive chart container behavior */
    @media (max-width: 1200px){ .app{ grid-template-columns: clamp(220px,24vw,280px) clamp(220px,24vw,280px) 1fr clamp(220px,24vw,280px); } }
    @media (max-width: 900px){ .chart-container{grid-column:2 / 5} }
    @media (max-width: 760px){ .app{ grid-template-columns: 1fr; grid-template-rows:auto; } .app > *{ grid-column:1 / -1 !important; } .chart-container{ grid-column:1 / -1; } .chart{ min-height:300px; } }
    /* Subtila scrollbars */
    *{ scrollbar-width:thin; scrollbar-color:var(--scroll-thumb) var(--scroll-track) }
    *::-webkit-scrollbar{ width:6px; height:6px }
    *::-webkit-scrollbar-track{ background:var(--scroll-track) }
    *::-webkit-scrollbar-thumb{ background:var(--scroll-thumb); border-radius:8px; border:1px solid #0b0c10 }
    *::-webkit-scrollbar-thumb:hover{ background:var(--scroll-thumb-hover) }
    *::-webkit-scrollbar-button{ width:0; height:0; display:none }
    *::-webkit-scrollbar-corner{ background:transparent }
    /* Breakpoint layout */
    .bp-header{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:6px}
    .bp-note{display:block;margin:4px 0 8px 0;color:var(--muted);font-size:10px}
    .breakpoint-panel .bp-controls{display:grid;grid-template-columns:1fr;gap:10px;margin-top:6px}
    .breakpoint-panel .btn{width:100%;border-radius:10px;padding:10px 14px;font-weight:600}
    .breakpoint-panel .btn-primary{background:var(--accent);border-color:var(--accent);color:#0b0c10}
    .breakpoint-panel .btn-primary:hover{filter:brightness(1.08);box-shadow:0 8px 18px rgba(75,163,242,.25),0 0 0 4px rgba(75,163,242,.2)}
    .breakpoint-panel .btn:active{transform:translateY(1px)}
    .breakpoint-panel{margin-bottom:12px}
  
.tooltip-label {
  font-size: 15px; /* ingress */
  line-height: 1.5;
  margin-bottom: 12px;
}

.stats-grid .small {
  font-size: 13px; /* punktlista */
  line-height: 1.5;
}


.arskp-about-link { cursor:pointer; }
.arskp-about-link:hover { text-decoration:none; }

</style>



<style id="arskp-tweaks">
  /* Center landing, slim logo weight, hide the small badge */
  #arskp-landing{ text-align:center; }
  #arskp-landing .arskp-title{ font-weight:700; } /* less fet */
  #arskp-landing .arskp-sub{ text-align:center; }
  #arskp-landing .arskp-actions{ justify-content:center; }
  #arskp-landing .arskp-badge{ display:none !important; }
  /* Scrollable panel window */
  #arskp-overlay{ padding:24px; }
  #arskp-overlay .arskp-panel{ 
    max-height: min(85vh, 740px);
    overflow:auto;
  }
  /* Keep top row with buttons visible while scrolling */
  
  /* Inline about link pinned without growing the panel */
  .panel.controls-panel{ position: relative; }
  .about-link-inline{
    position:absolute; top:8px; right:12px;
    font-size:12px; color: var(--accent); text-decoration:underline;
    cursor:pointer;
  }
</style>

<style id="arskp-tweaks-2">
  /* Panel scrolling without sticky header */
  #arskp-overlay{ padding:24px; }
  #arskp-overlay .arskp-panel{ max-height:min(86vh, 760px); overflow:auto; }
  /* Type scale for about content */
  .arskp-about h1{ font-size: clamp(24px, 3.2vw, 34px); line-height:1.25; margin:0 0 10px 0; }
  .arskp-about h2{ font-size: clamp(16px, 2.2vw, 20px); line-height:1.4; margin:16px 0 6px 0; }
  .arskp-about p, .arskp-about li{ font-size: 15px; line-height: 1.65; }
</style>

<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2064%2064%22%3E%0A%20%20%3Crect%20width%3D%2264%22%20height%3D%2264%22%20rx%3D%2212%22%20fill%3D%22%234BA3F2%22/%3E%0A%20%20%3Ctext%20x%3D%2250%25%22%20y%3D%2254%25%22%20text-anchor%3D%22middle%22%20font-family%3D%22Inter%2C%20system-ui%2C%20-apple-system%2C%20sans-serif%22%20font-size%3D%2234%22%20font-weight%3D%22800%22%20fill%3D%22%230b0c10%22%3EAS%3C/text%3E%0A%3C/svg%3E">

<style id="about-link-style">
.about-link-inline{position:absolute;top:8px;right:12px;font-size:12px;line-height:1;
  color:#4BA3F2;text-decoration:underline;cursor:pointer;}
.about-link-inline:hover{text-decoration:none;filter:brightness(1.1);}
</style>

<style id="responsive-tweaks-v7">
/* Earlier stacking and cleaner small-screen layout */
@media (max-width: 1100px){
  .legend{ gap:8px; font-size:10px; }
  .legend .legend-item{ flex:1 1 calc(50% - 8px); }
}
@media (max-width: 980px){
  .chart-container{ grid-column: 1 / -1 !important; }
  .legend{ width:100%; max-height: 180px; overflow:auto; }
  .chart{ min-height: 360px; }
}
@media (max-width: 760px){
  .app{ grid-template-columns: 1fr !important; grid-template-rows: auto; }
  .panel.top-controls,
  .panel.controls-panel,
  .panel.breakpoint-panel{ grid-column: 1 / -1 !important; }
  .legend .legend-item{ flex:1 1 100%; }
  .chart{ min-height: 320px; }
}
</style>
</head>
<body>
<div class="app">
  <!-- Makro panel -->
  <div class="panel top-controls macro-controls" style="grid-column:1;grid-row:1;">
    <div class="title">POLITIKK & MAKRO</div>
    <!-- Scenario dropdown (enkel) -->
    <div class="control">
      <label><span>Scenario</span></label>
      <select id="scenarioSelect" class="select">
        <option value="egen" selected>Egen (manuell)</option>
        <option value="normal">Normal / stabil</option>
        <option value="low">Global lågkonjunktur</option>
        <option value="boom">Global boom</option>
        <option value="geo">Geopolitisk konflikt</option>
        <option value="tech">Teknologiskt genombrott</option>
        <option value="green">Grön omställning globalt</option>
      </select>
    </div>
    <div class="control"><label><span>Rente</span><span class="value-bubble"><span id="rateVal">3.0</span>%</span></label><input id="rate" type="range" min="0" max="10" step="0.1" value="3"/></div>
    <div class="control"><label><span>Konjunktur</span><span class="value-bubble" id="cycleLabel">Normal</span></label><div class="scale-labels">Lav · Normal · Høy</div><input id="cycle" type="range" min="1" max="10" step="1" value="5"/></div>
    <div class="control"><label><span>Offentlige investeringer</span><span class="value-bubble" id="publicSpendLabel">Normal</span></label><div class="scale-labels">Kutt · Normal · Vekst</div><input id="publicSpend" type="range" min="1" max="10" step="1" value="5"/></div>
    <div class="control"><label><span>Materialkostnader</span><span class="value-bubble" id="materialsLabel">Middels</span></label><div class="scale-labels">Lave · Middels · Høye</div><input id="materials" type="range" min="1" max="10" step="1" value="5"/></div>
    <div class="control"><label><span>Bærekraftkrav</span><span class="value-bubble" id="sustainReqLabel">Moderate</span></label><div class="scale-labels">Lave · Moderate · Strenge</div><input id="sustainReq" type="range" min="1" max="10" step="1" value="5"/></div>
    <div class="control"><label><span>Teknologigjennombrudd</span><span class="value-bubble" id="techBreakLabel">Ingen</span></label><div class="scale-labels">Ingen · Moderate · Store</div><input id="techBreak" type="range" min="1" max="10" step="1" value="5"/></div>
    <div class="control"><label><span>Reguleringsnivå</span><span class="value-bubble" id="regLevelLabel">Middels</span></label><div class="scale-labels">Lavt · Middels · Høyt</div><input id="regLevel" type="range" min="1" max="10" step="1" value="5"/></div>
    <div class="control"><label><span>Global økonomi</span><span class="value-bubble" id="globEcoLabel">Normal</span></label><div class="scale-labels">Svak · Normal · Sterk</div><input id="globalEconomy" type="range" min="1" max="10" step="1" value="6"/></div>
  </div>
  <!-- Strategi panel -->
  <div class="panel top-controls" style="grid-column:2;grid-row:1;">
    <div class="title">KONTOR & STRATEGI</div>
    <div class="control"><label><span>Kontor</span></label><select id="firmSelect" class="select"></select></div>
    <div class="control"><label><span>Strategi</span></label>
      <select id="strategySelect" class="select">
        <option value="egen" selected>Egen (manuell)</option>
        <option value="innovasjon">Innovasjonsleder</option>
        <option value="kostnad">Kostnadsleder</option>
        <option value="offentlig">Offentlig fokus</option>
        <option value="privat">Privat fokus</option>
        <option value="gronn">Grønn profil</option>
        <option value="intl">Internasjonal ekspansjon</option>
        <option value="balansert">Balansert</option>
      </select>
    </div>
    <div class="control"><label><span>Privat andel</span><span class="value-bubble" id="pPrivV">6</span></label><div class="scale-labels">&nbsp;</div><input id="pPriv" type="range" min="1" max="10" step="1" value="6"/></div>
    <div class="control"><label><span>Kunder og salg</span><span class="value-bubble" id="pFinV">7</span></label><div class="scale-labels">&nbsp;</div><input id="pFin" type="range" min="1" max="10" step="1" value="7"/></div>
    <div class="control"><label><span>Offentlig andel</span><span class="value-bubble" id="pPubV">6</span></label><div class="scale-labels">&nbsp;</div><input id="pPub" type="range" min="1" max="10" step="1" value="6"/></div>
    <div class="control"><label><span>Talent & kapasitet</span><span class="value-bubble" id="pTalV">7</span></label><div class="scale-labels">&nbsp;</div><input id="pTal" type="range" min="1" max="10" step="1" value="7"/></div>
    <div class="control"><label><span>Bærekraft</span><span class="value-bubble" id="pSusV">8</span></label><div class="scale-labels">&nbsp;</div><input id="pSus" type="range" min="1" max="10" step="1" value="8"/></div>
    <div class="control"><label><span>Teknologi</span><span class="value-bubble" id="pTechV">7</span></label><div class="scale-labels">&nbsp;</div><input id="pTech" type="range" min="1" max="10" step="1" value="7"/></div>
    <div class="control"><label><span>Innovasjon</span><span class="value-bubble" id="pInvV">7</span></label><div class="scale-labels">&nbsp;</div><input id="pInv" type="range" min="1" max="10" step="1" value="7"/></div>
    <div class="control"><label><span>Internasjonalisering</span><span class="value-bubble" id="pIntV">6</span></label><div class="scale-labels">&nbsp;</div><input id="pInt" type="range" min="1" max="10" step="1" value="6"/></div>
  </div>
  <!-- Chart -->
  <div class="chart-container">
    <div class="chart-panel">
      <div class="chart-top">
        <div class="title" id="chartTitle">Omsetningsutvikling 2020-2026 (indeks 2020=100)</div>
        <div style="display:flex;gap:10px;align-items:center">
          <select id="metricSelect" class="select">
            <option value="revenue" selected>Omsetning</option>
            <option value="profit">Resultat</option>
            <option value="margin">Marginer</option>
          </select>
          <label class="badge" id="indexWrap" style="cursor:pointer"><input id="indexToggle" type="checkbox" checked style="margin-right:6px">Indeks 2020=100</label>
        </div>
      </div>
      <div class="small" id="metricHelp">Velg nøkkeltall: Omsetning, resultat eller marginer.</div>
      <svg id="chart" class="chart"></svg>
    </div>
    <div class="legend" id="legend"></div>
  </div>
  <!-- Breakpoint Controller -->
  <div class="panel breakpoint-panel">
    <div class="title">Breakpoint Controller</div>
    <div class="bp-header">
      <span class="badge">Synlig: <b id="activeRange">2020→2026</b></span>
      <span class="badge">Aktivt år: <b id="nextYearBadge">2026</b></span>
      <span class="badge">Antall breakpoints: <b id="bpCount">0</b></span>
    </div>
    <div class="bp-note small">Breakpoints låser historikken, reglene påvirker bare fremtiden.</div>
    <div class="bp-controls">
      <button class="btn btn-primary" id="saveBP">Lagre breakpoint</button>
      <button class="btn" id="clearBP">Tøm siste</button>
    </div>
  </div>
  <!-- Bottom responsive area -->
  <div class="bottom-grid">
    <div class="panel stats-panel">
      <div class="title" id="statsTitle">Toppliste, Omsetning</div>
      <div id="stats-content"></div>
    </div>
    <div class="panel controls-panel">
      <div class="title">INSTRUKSJONER</div><a id="arskp-about-link-inline" class="about-link-inline" href="#">Om verktøyet</a>
      <div class="tooltip-label">
        Dette er en helt unødvendig, men forhåpentligvis morsom simulator. Alt her er på liksom, tallene er syntetiske og resultatene har ingen prognoseverdi. Bruk den til å utforske ideer og diskutere med kollegaer, ikke til beslutninger.
      </div>
<div class="small" style="margin-top:8px"><strong>Merk:</strong> Verktøyet kan fortsatt inneholde enkelte feil, og resultater kan være uforutsigbare.</div>
      <div class="stats-grid" style="margin-top:8px">
        <div class="small">
          • Velg kontor i «Kontor». A-Lab er valgt ved oppstart.<br>
          • Velg strategi. «Egen» betyr at du styrer alle verdier manuelt.<br>
          • I «Politikk & makro» kan du velge scenario eller justere skyveknappene. Manuelle endringer setter scenario til «Egen».<br>
          • Over grafen velger du nøkkeltall. Slå av «Indeks 2020=100» for å vise MNOK.
        </div>
        <div class="small">
          • «Lagre breakpoint» låser historikken til året du ser. Reglene påvirker bare årene etter. «Tøm siste» fjerner siste breakpoint.<br>
          • Under grafen kan du slå av og på firmaer. Valgt kontor vises tydelig, andre er lysere og alle stiplet etter siste breakpoint.<br>
          • Årstall vises nederst i grafen.<br>
          • «Prognose» viser nivå i siste synlige år for valgt nøkkeltall.
        </div>
      </div>
    </div>
    </div>
  </div>
</div>
<script>
/* ---- Data ---- */
const YEARS = Array.from({length:16}, (_,i)=>2020+i);
// Omsetning (1000 NOK) 2020–2024 fra proff (delmengde – resten beregnes)
const REVENUE_2020_2024 = {
  "Snøhetta Oslo AS": [123910,172272,195063,506145,425019],
  "LINK Arkitektur AS": [427933,399562,381292,405318,404894],
  "Nordic Office of Architecture AS": [372895,361434,325973,349683,347333],
  "LPO Arkitekter AS": [220767,172495,176709,197796,187704],
  "Arkitema AS": [126634,105627,127754,141241,150518],
  "A-Lab AS": [175187,163800,156609,134928,142053],
  "Hille Melbye Arkitekter AS": [104693,100242,95271,103031,102841],
  "MAD Arkitekter AS": [67786,78827,88613,88423,83958],
  "NSW Arkitektur AS": [58191,54808,50946,60559,46943],
  "DARK Arkitekter AS": [115341,124614,115923,111541,106412],
  "Ghilardi+Hellsten Arkitekter AS": [24086,23721,22656,14173,13751],
  "Jensen & Skodvin Arkitektkontor AS": [1765,11293,18752,24056,37021],
  "Arkitektfirma Helen & Hard AS": [28111,28136,34010,34855,33417],
  "Atelier Oslo AS": [22440,21681,28464,19159,19575],
  "Lund Hagem Arkitekter AS": [83169,90846,103360,95276,97302]};
const firms = [
  {name:"DARK Arkitekter AS", revenue:106.412, staff:66, color:"#ff6b6b",
   params:{Innovasjon:8,Bærekraft:8,Internasjonalisering:6,"Offentlig andel":6,"Privat andel":6,Teknologi:8,"Talent & kapasitet":8,"Kunder og salg":8}},
  {name:"Snøhetta Oslo AS", revenue:425.0, staff:96, color:"#4BA3F2",
   params:{Innovasjon:9,Bærekraft:7,Internasjonalisering:10,"Offentlig andel":4,"Privat andel":5,Teknologi:9,"Talent & kapasitet":9,"Kunder og salg":9}},
  {name:"LINK Arkitektur AS", revenue:404.9, staff:267, color:"#4ecdc4",
   params:{Innovasjon:7,Bærekraft:9,Internasjonalisering:6,"Offentlig andel":7,"Privat andel":6,Teknologi:7,"Talent & kapasitet":7,"Kunder og salg":8}},
  {name:"Nordic Office of Architecture AS", revenue:347.3, staff:188, color:"#45b7d1",
   params:{Innovasjon:7,Bærekraft:8,Internasjonalisering:8,"Offentlig andel":8,"Privat andel":5,Teknologi:8,"Talent & kapasitet":8,"Kunder og salg":9}},
  {name:"LPO Arkitekter AS", revenue:187.7, staff:120, color:"#f9ca24",
   params:{Innovasjon:7,Bærekraft:7,Internasjonalisering:6,"Offentlig andel":6,"Privat andel":7,Teknologi:6,"Talent & kapasitet":7,"Kunder og salg":8}},
  {name:"Arkitema AS", revenue:150.5, staff:84, color:"#6c5ce7",
   params:{Innovasjon:7,Bærekraft:7,Internasjonalisering:7,"Offentlig andel":7,"Privat andel":6,Teknologi:7,"Talent & kapasitet":7,"Kunder og salg":8}},
  {name:"A-Lab AS", revenue:142.1, staff:96, color:"#a29bfe",
   params:{Innovasjon:8,Bærekraft:8,Internasjonalisering:7,"Offentlig andel":6,"Privat andel":7,Teknologi:8,"Talent & kapasitet":7,"Kunder og salg":8}},
  {name:"Hille Melbye Arkitekter AS", revenue:102.8, staff:50, color:"#fd79a8",
   params:{Innovasjon:6,Bærekraft:6,Internasjonalisering:5,"Offentlig andel":7,"Privat andel":6,Teknologi:5,"Talent & kapasitet":6,"Kunder og salg":7}},
  {name:"Lund Hagem Arkitekter AS", revenue:97.3, staff:61, color:"#00b894",
   params:{Innovasjon:9,Bærekraft:8,Internasjonalisering:7,"Offentlig andel":5,"Privat andel":8,Teknologi:8,"Talent & kapasitet":8,"Kunder og salg":8}},
  {name:"MAD Arkitekter AS", revenue:84.0, staff:70, color:"#e17055",
   params:{Innovasjon:9,Bærekraft:8,Internasjonalisering:6,"Offentlig andel":5,"Privat andel":8,Teknologi:8,"Talent & kapasitet":7,"Kunder og salg":7}},
  {name:"NSW Arkitektur AS", revenue:46.9, staff:32, color:"#fdcb6e",
   params:{Innovasjon:7,Bærekraft:7,Internasjonalisering:5,"Offentlig andel":6,"Privat andel":7,Teknologi:6,"Talent & kapasitet":6,"Kunder og salg":7}},
  {name:"Ghilardi+Hellsten Arkitekter AS", revenue:13.751, staff:13, color:"#9b59b6", params:{Innovasjon:7,Bærekraft:7,Internasjonalisering:5,"Offentlig andel":6,"Privat andel":7,Teknologi:6,"Talent & kapasitet":6,"Kunder og salg":7}},
  {name:"Jensen & Skodvin Arkitektkontor AS", revenue:37.021, staff:0, color:"#9b59b6", params:{Innovasjon:7,Bærekraft:7,Internasjonalisering:5,"Offentlig andel":6,"Privat andel":7,Teknologi:6,"Talent & kapasitet":6,"Kunder og salg":7}},
  {name:"Arkitektfirma Helen & Hard AS", revenue:33.417, staff:29, color:"#9b59b6", params:{Innovasjon:7,Bærekraft:7,Internasjonalisering:5,"Offentlig andel":6,"Privat andel":7,Teknologi:6,"Talent & kapasitet":6,"Kunder og salg":7}},
  {name:"Atelier Oslo AS", revenue:19.575, staff:16, color:"#9b59b6", params:{Innovasjon:7,Bærekraft:7,Internasjonalisering:5,"Offentlig andel":6,"Privat andel":7,Teknologi:6,"Talent & kapasitet":6,"Kunder og salg":7}}
];
/* ---- Strategi-presets ---- */
const STRATEGY_PRESETS = {
  egen:null,
  innovasjon:{Innovasjon:9, Teknologi:8, "Talent & kapasitet":8, "Kunder og salg":7, Bærekraft:8, "Privat andel":6, "Offentlig andel":5, Internasjonalisering:7},
  kostnad:{Innovasjon:5, Teknologi:7, "Talent & kapasitet":7, "Kunder og salg":8, Bærekraft:6, "Privat andel":7, "Offentlig andel":5, Internasjonalisering:5},
  offentlig:{Innovasjon:6, Teknologi:6, "Talent & kapasitet":7, "Kunder og salg":7, Bærekraft:8, "Privat andel":4, "Offentlig andel":8, Internasjonalisering:5},
  privat:{Innovasjon:7, Teknologi:7, "Talent & kapasitet":7, "Kunder og salg":7, Bærekraft:6, "Privat andel":8, "Offentlig andel":4, Internasjonalisering:6},
  gronn:{Innovasjon:7, Teknologi:7, "Talent & kapasitet":7, "Kunder og salg":7, Bærekraft:9, "Privat andel":5, "Offentlig andel":7, Internasjonalisering:6},
  intl:{Innovasjon:8, Teknologi:7, "Talent & kapasitet":7, "Kunder og salg":7, Bærekraft:7, "Privat andel":7, "Offentlig andel":5, Internasjonalisering:9},
  balansert:{Innovasjon:7, Teknologi:7, "Talent & kapasitet":7, "Kunder og salg":7, Bærekraft:7, "Privat andel":6, "Offentlig andel":6, Internasjonalisering:7}
};
/* ---- Scenario-presets för makro ---- */
const SCENARIO_PRESETS = {
  normal: { rate:3.0, cycle:5, publicSpend:5, materials:5, sustainReq:5, techBreak:5, regLevel:5, globalEconomy:6 },
  low:    { rate:2.0, cycle:3, publicSpend:6, materials:4, sustainReq:5, techBreak:5, regLevel:6, globalEconomy:3 },
  boom:   { rate:4.0, cycle:8, publicSpend:4, materials:7, sustainReq:5, techBreak:6, regLevel:5, globalEconomy:8 },
  geo:    { rate:4.5, cycle:4, publicSpend:7, materials:8, sustainReq:6, techBreak:5, regLevel:7, globalEconomy:3 },
  tech:   { rate:3.0, cycle:6, publicSpend:6, materials:5, sustainReq:6, techBreak:9, regLevel:5, globalEconomy:7 },
  green:  { rate:3.0, cycle:6, publicSpend:7, materials:6, sustainReq:9, techBreak:7, regLevel:7, globalEconomy:6 }};
/* ---- Avleder historikk: omsetning (MNOK), resultat (MNOK), margin (%) ---- */
function toIndex2020(arr){ const base = arr[0] || 1; return arr.map(v=> +((v/base)*100).toFixed(1)); }
const FALLBACK_INDEX_2020_2024_2024BASE = {"Dark Design Group":[90,95,99,96,100],"Lund Hagem Arkitekter AS":[92,97,102,99,103]};
const REVENUE_ABS_MNOK = {};
firms.forEach(f=>{
  const n=f.name; const raw = REVENUE_2020_2024[n];
  if (raw){ REVENUE_ABS_MNOK[n]=raw.map(v=> +(v/1000).toFixed(1)); }
  else { const idx=FALLBACK_INDEX_2020_2024_2024BASE[n]||[90,95,99,96,100]; const b=f.revenue; REVENUE_ABS_MNOK[n]=idx.map(v=> +(b*(v/100)).toFixed(1)); }
});
function clamp(v,a,b){return Math.max(a, Math.min(b, v));}
function baseMarginPctFor(f){ const p=f.params; let m=5 + 1.2*(p["Kunder og salg"]-6) + 0.8*(p["Talent & kapasitet"]-6) + 0.5*(p["Teknologi"]-6) + 0.3*(p["Innovasjon"]-6) - 0.4*(p["Offentlig andel"]-6) + 0.2*(p["Privat andel"]-6); return +clamp(m,4,22).toFixed(1); }
const MARGIN_PCT = {}; const PROFIT_ABS_MNOK = {};
firms.forEach(f=>{ const m=baseMarginPctFor(f); MARGIN_PCT[f.name]=[m,m,m,m,m]; const rev=REVENUE_ABS_MNOK[f.name]; PROFIT_ABS_MNOK[f.name]=rev.map(r=> +(r*m/100).toFixed(1)); });
const BASE_REVENUE_IDX = {}; const BASE_PROFIT_IDX = {};
firms.forEach(f=>{ BASE_REVENUE_IDX[f.name]=toIndex2020(REVENUE_ABS_MNOK[f.name]); BASE_PROFIT_IDX[f.name]=toIndex2020(PROFIT_ABS_MNOK[f.name]); });
/* ---- Breakpoints ---- */
const breakpoints = {}; let visibleEnd = 2026;
/* ---- Helpers ---- */
const chart = document.getElementById('chart');
const legend = document.getElementById('legend');
const metricSelect = document.getElementById('metricSelect');
const statsTitleEl = document.getElementById('statsTitle');
let currentMetric = 'revenue';
let useIndex = true; const indexToggle = document.getElementById('indexToggle');
let useIndexSavedBeforeMargin = true;
if (indexToggle){ indexToggle.addEventListener('change', e=>{ useIndex = e.target.checked; draw(); }); }
if (metricSelect){
  metricSelect.addEventListener('change', e=>{
    const nextMetric = e.target.value;
    if (nextMetric === 'margin'){
      // Save current index state, force non-index for margins, disable toggle
      useIndexSavedBeforeMargin = useIndex;
      useIndex = false;
      if(indexToggle){ indexToggle.checked=false; indexToggle.disabled=true; }
    } else {
      // Restore previous index state when leaving margin
      if(indexToggle){ indexToggle.disabled=false; }
      useIndex = useIndexSavedBeforeMargin;
      if(indexToggle){ indexToggle.checked = useIndex; }
    }
    currentMetric = nextMetric;
    draw();
  });
}

/* ---- Init: kun A-Lab synlig og valgt ---- */
let selectedFirmName = 'A-Lab AS';
const visible = Object.fromEntries(firms.map(f => [f.name, f.name === 'A-Lab AS']));
const firmSelect = document.getElementById('firmSelect');
const strategySelect = document.getElementById('strategySelect');
const scenarioSelect = document.getElementById('scenarioSelect');
const nextYearBadge = document.getElementById('nextYearBadge');
/* Helper to strip trailing 'AS' in display lists */
function displayName(name){ try { return name.replace(/\s+AS$/,''); } catch(e){ return name; } }

/* ---- Legend ---- */
function renderLegend(){
  legend.innerHTML='';
  const sorted=[...firms].sort((a,b)=>a.name.localeCompare(b.name,'nb'));
  sorted.forEach(f=>{
    const item=document.createElement('div');item.className='legend-item';
    const cb=document.createElement('input');cb.type='checkbox';cb.checked=!!visible[f.name];cb.disabled=f.isDark;cb.onchange=()=>{visible[f.name]=cb.checked;draw();};
    const dot=document.createElement('div');dot.className='legend-dot';dot.style.background=f.color;
    const name=document.createElement('span');name.className='legend-name';name.textContent = displayName(f.name);
    const tip=document.createElement('div');tip.className='tooltip';tip.style.display='none';
    let rows=`<div class="tooltip-row"><span class="tooltip-label">Omsetning:</span><span class="tooltip-value">${f.revenue.toFixed(1)} MNOK</span></div>
      <div class="tooltip-row"><span class="tooltip-label">Ansatte:</span><span class="tooltip-value">${f.staff}</span></div>`;
    const paramOrder=["Innovasjon","Bærekraft","Teknologi","Kunder og salg","Talent & kapasitet","Offentlig andel","Privat andel","Internasjonalisering"];
    paramOrder.forEach(k=>{ if(f.params[k]!==undefined){ rows+=`<div class="tooltip-row"><span class="tooltip-label">${k}:</span><span class="tooltip-value">${f.params[k]}/10</span></div>`; } });
    item.appendChild(cb);item.appendChild(dot);item.appendChild(name);tip.innerHTML=rows;item.appendChild(tip);legend.appendChild(item);
  });
}
/* ---- Firm dropdown: alfabetisk ---- */
function populateFirmSelect(){
  if (!firmSelect) return;
  firmSelect.innerHTML = '';
  const sorted=[...firms].sort((a,b)=>a.name.localeCompare(b.name,'nb'));
  sorted.forEach(f=>{
    const opt=document.createElement('option');
    opt.value=f.name; opt.textContent = displayName(f.name); if(f.name===selectedFirmName) opt.selected=true; firmSelect.appendChild(opt);
  });
}
function updateStrategyBubbles(){
  const map={pInv:'pInvV',pSus:'pSusV',pInt:'pIntV',pPub:'pPubV',pPriv:'pPrivV',pTech:'pTechV',pTal:'pTalV',pFin:'pFinV'};
  Object.entries(map).forEach(([id,lab])=>{ const el=document.getElementById(id); const lb=document.getElementById(lab); if(el&&lb){ lb.textContent=el.value; }});
}
function setSlidersFromParams(params){
  const map={pInv:'Innovasjon',pSus:'Bærekraft',pInt:'Internasjonalisering',pPub:'Offentlig andel',pPriv:'Privat andel',pTech:'Teknologi',pTal:'Talent & kapasitet',pFin:'Kunder og salg'};
  Object.entries(map).forEach(([id,key])=>{ const el=document.getElementById(id); if(!el) return; const v=params[key]; if(typeof v==='number'){ el.value=v; }});
  updateStrategyBubbles(); draw();
}
function setSelectedFirm(name){
  selectedFirmName = name;
  firms.forEach(f=> f.isDark = (f.name===name));
  visible[name]=true;
  renderLegend();
  const f=firms.find(x=>x.name===name); if (f) setSlidersFromParams(f.params);
  if (strategySelect) strategySelect.value='egen';
  draw();
}
if (firmSelect){ firmSelect.addEventListener('change', e=> setSelectedFirm(e.target.value)); }
/* ---- Strategi presets ---- */
if (strategySelect){
  strategySelect.addEventListener('change', e=>{
    const key=e.target.value; const preset=STRATEGY_PRESETS[key];
    if (!preset){ const f=firms.find(x=>x.name===selectedFirmName); if (f) setSlidersFromParams(f.params); return; }
    setSlidersFromParams(preset);
  });
}
/* ---- Läs kontroller ---- */
function macroNow(){
  return {
    rate:+document.getElementById('rate').value,
    cycle:+document.getElementById('cycle').value,
    materials:+document.getElementById('materials').value,
    sustainReq:+document.getElementById('sustainReq').value,
    techBreak:+document.getElementById('techBreak').value,
    regLevel:+document.getElementById('regLevel').value,
    publicSpend:+document.getElementById('publicSpend').value,
    globalEconomy:+document.getElementById('globalEconomy').value
  };
}
function darkNow(){return{Innovasjon:+document.getElementById('pInv').value,Bærekraft:+document.getElementById('pSus').value,Internasjonalisering:+document.getElementById('pInt').value,"Offentlig andel":+document.getElementById('pPub').value,"Privat andel":+document.getElementById('pPriv').value,Teknologi:+document.getElementById('pTech').value,"Talent & kapasitet":+document.getElementById('pTal').value,"Kunder og salg":+document.getElementById('pFin').value}};
['rate'].forEach(id=>document.getElementById(id).addEventListener('input',e=>{document.getElementById('rateVal').textContent=e.target.value; draw();}));
['pInv','pSus','pInt','pPub','pPriv','pTech','pTal','pFin'].forEach(id=>{const map={pInv:'pInvV',pSus:'pSusV',pInt:'pIntV',pPub:'pPubV',pPriv:'pPrivV',pTech:'pTechV',pTal:'pTalV',pFin:'pFinV'};document.getElementById(id).addEventListener('input',e=>{document.getElementById(map[id]).textContent=e.target.value;draw();});});
['cycle','materials','sustainReq','techBreak','regLevel','publicSpend','globalEconomy'].forEach(id=>document.getElementById(id).addEventListener('input',()=>{updateMacroLabels();draw();}));
/* ---- Koppla sliders till scenario = egen vid manuell ändring ---- */
['rate','cycle','materials','sustainReq','techBreak','regLevel','publicSpend','globalEconomy'].forEach(id=>{
  const el=document.getElementById(id);
  if (el) el.addEventListener('input', ()=>{ if (scenarioSelect) scenarioSelect.value='egen'; });
});
function updateMacroLabels(){
  const triBucket=v=>v<=3?0:(v<=7?1:2);
  const set=(id,text)=>{const el=document.getElementById(id); if(el) el.textContent=text;};
  set('cycleLabel',['Lav','Normal','Høy'][triBucket(+document.getElementById('cycle').value)]);
  set('materialsLabel',['Lave','Middels','Høye'][triBucket(+document.getElementById('materials').value)]);
  set('sustainReqLabel',['Lave','Moderate','Strenge'][triBucket(+document.getElementById('sustainReq').value)]);
  set('techBreakLabel',['Ingen','Moderate','Store'][triBucket(+document.getElementById('techBreak').value)]);
  set('regLevelLabel',['Lavt','Middels','Høyt'][triBucket(+document.getElementById('regLevel').value)]);
  set('publicSpendLabel',['Kutt','Normal','Vekst'][triBucket(+document.getElementById('publicSpend').value)]);
  set('globEcoLabel',['Svak','Normal','Sterk'][triBucket(+document.getElementById('globalEconomy').value)]);
}
updateMacroLabels();
updateStrategyBubbles();
/* ---- Scenario-dropdown logik ---- */
if (scenarioSelect){
  scenarioSelect.addEventListener('change', e=>{
    const key = e.target.value;
    if (key === 'egen') return;
    const preset = SCENARIO_PRESETS[key];
    if (!preset) return;
    const setVal = (id, v)=>{ const el=document.getElementById(id); if(el){ el.value = v; } };
    setVal('rate', preset.rate); document.getElementById('rateVal').textContent = (+preset.rate).toFixed(1);
    setVal('cycle', preset.cycle);
    setVal('publicSpend', preset.publicSpend);
    setVal('materials', preset.materials);
    setVal('sustainReq', preset.sustainReq);
    setVal('techBreak', preset.techBreak);
    setVal('regLevel', preset.regLevel);
    setVal('globalEconomy', preset.globalEconomy);
    updateMacroLabels();
    draw();
  });
}
/* ---- Breakpoint UI ---- */
function nextSelectableYear(){ const years=Object.keys(breakpoints).map(Number); if (!years.length) return 2025; const last=Math.max(...years); return Math.min(2035, last+1); }
function refreshBPSelect(){ const y=nextSelectableYear(); if (nextYearBadge) nextYearBadge.textContent=String(y); }
function updateBreakpointUI(){ const ar=document.getElementById('activeRange'); if (ar) ar.textContent=`2020→${visibleEnd}`; const cnt=document.getElementById('bpCount'); if (cnt) cnt.textContent=Object.keys(breakpoints).length; refreshBPSelect(); }

// ---- Seed initial breakpoint at 2025 (locks history 2020–2024) ----
(function seedBP2025(){
  try {
    if (!Object.keys(breakpoints).length) {
      breakpoints[2025] = { macro: macroNow(), dark: darkNow(), darkTarget: selectedFirmName };
      visibleEnd = Math.max(visibleEnd, 2026);
    }
    updateBreakpointUI();
  } catch(e){
    console.warn('BP2025 init warning:', e);
  }
})();

document.getElementById('saveBP').onclick=()=>{ const year=nextSelectableYear(); if (breakpoints[year]) return; breakpoints[year]={ macro: macroNow(), dark: darkNow(), darkTarget: selectedFirmName }; visibleEnd=Math.min(2035, Math.max(visibleEnd, year+1)); updateBreakpointUI(); draw(); };
/* ---- Tøm siste (ikke alle) ---- */
document.getElementById('clearBP').onclick=()=>{ 
  const years = Object.keys(breakpoints).map(Number);
  if (!years.length) return;
  const last = Math.max(...years);
  deleteBreakpoint(last);
};
function deleteBreakpoint(year){
  delete breakpoints[year];
  const visYears=Object.keys(breakpoints).map(Number).filter(y=>y<=visibleEnd);
  const maxBP=visYears.length?Math.max(...visYears):null;
  visibleEnd = maxBP ? Math.max(visibleEnd, maxBP+1) : 2025;
  updateBreakpointUI(); 
  draw(); 
}
/* ---- Modell ---- */
/* Kalibrerad ekonomisk modell (pedagogisk). */
function _s01(v){ return (v - 5)/5; }             // 1..10 → [-0.8, +1.0]
function _clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }
function _toShare(pub, priv){ const s=(pub||0)+(priv||0) || 1; return {pub:(pub||0)/s, priv:(priv||0)/s}; }
function _pos(x){ return Math.max(0, x); }

const G0 = 0.015;          // 1.5% bas-tillväxt
const M0_FLOOR = 2.0, M0_CEIL = 25.0;

function multipliers(metric){ return {macro:1.0, strat:1.0, marginScale:1.0}; }

function _baseRevenueMNOK(name){ return REVENUE_ABS_MNOK[name].slice(); }
function _baseProfitMNOK(name){ return PROFIT_ABS_MNOK[name].slice(); }
function _baseMarginPct(name){ return MARGIN_PCT[name].slice(); }

function getBaseSeries(metric, name){
  if (metric==='revenue') return useIndex ? toIndex2020(REVENUE_ABS_MNOK[name]) : REVENUE_ABS_MNOK[name];
  if (metric==='profit')  return useIndex ? toIndex2020(PROFIT_ABS_MNOK[name])  : PROFIT_ABS_MNOK[name];
  if (metric==='margin')  return MARGIN_PCT[name];
  return toIndex2020(REVENUE_ABS_MNOK[name]);
}

// Makro → efterfrågan D samt kostnad C, D dämpas av offentlig andel
function _macroDC(m, sharePub){
  const z_cycle = _s01((m.cycle!=null? m.cycle : (m.globalEconomy!=null? m.globalEconomy : 5)));
  const z_rate  = _clamp((3.0 - (m.rate!=null? m.rate:3.0))/7.0, -1, 1);
  const z_mat   = _s01(10 - (m.materials!=null? m.materials:5));
  const z_milj  = _s01(m.sustainReq!=null? m.sustainReq:5);
  const z_tech  = _s01(m.techBreak!=null? m.techBreak:5);
  const z_pubsp = _s01(m.publicSpend!=null? m.publicSpend:5);
  const z_reg   = _s01(m.regLevel!=null? m.regLevel:5);

  let D = 0;
  D += 0.10*z_cycle;
  D += 0.06*z_rate;
  D += 0.06*z_mat;
  D += 0.02*_pos(z_milj);
  D += 0.01*_pos(z_tech);
  D += 0.03*_pos(z_pubsp)*sharePub;
  D += -0.01*_pos(z_reg);

  let C = 0;
  C += 0.02*(-z_rate);
  C += 0.04*(-z_mat);
  C += 0.02*_pos(z_milj);
  C += 0.01*(-_pos(z_tech));
  C += 0.01*_pos(z_reg);

  const D_eff = D * (1 - 0.4*sharePub);
  return {D, C, D_eff, z_milj};
}

// Strategibidrag, inklusive Baerekraft och Internasjonalisering samt andelsmix
function _strategyDelta(d, macro, yearOffsetInSeg){
  if (!d) return {dg:0, dM:0, dK:0, shares:{pub:0.5, priv:0.5}};
  const s_salg   = _s01(d["Kunder og salg"]||6);
  const s_tal    = _s01(d["Talent & kapasitet"]||6);
  const s_tech   = _s01(d["Teknologi"]||6);
  const s_innov  = _s01(d["Innovasjon"]||6);
  const s_baer   = _s01(d["Bærekraft"]||5);
  const s_intl   = _s01(d.Internasjonalisering||5);
  const shares   = _toShare(d["Offentlig andel"]||5, d["Privat andel"]||5);

  // Makroeffekter
  const {D, D_eff, z_milj} = _macroDC(macro, shares.pub);

  // Innovation, 2 års lagg inom segment
  const lagFactor = _clamp(yearOffsetInSeg/2, 0, 1);
  const dg_innov  = 0.03 * s_innov * lagFactor;

  let dg  = 0;
  // Sälj sensitivt mot konjunktur, förstärks av internationalisering
  const D_exposure = D_eff * (1 + 0.6*s_intl);
  dg     += 0.05 * s_salg * (1 + D_exposure);
  dg += 0.02 * s_tal;
  dg     += 0.02 * s_tech * (1 + 0.3*_pos(z_milj)) * (1 + 0.5*s_tal);
  dg += 0.02 * s_baer * _pos(z_milj);
  // Mix: privat marknad ger högre trendtillväxt, offentlig stabiliserar
  dg += 0.015 * (shares.priv - 0.5);

  let dK  = 0;
  dK     += 0.01 * Math.max(0, s_salg);
  dK     += 0.02 * Math.max(0, s_tal);
  const x = Math.max(0, s_tech);
  dK     += 0.012 * x - 0.01 * x * x;

  let dM  = 0;
  dM     += 0.015 * Math.max(0, s_salg);
  dM += 0.006 * s_tal;
  dM     += 0.005 * s_innov;
  dM += 0.006 * s_baer * _pos(z_milj);
  // Mixeffekt: mer offentlig ger lite lägre marginal, privat lite högre
  dM += -0.012*(shares.pub - 0.5) + 0.012*(shares.priv - 0.5);

  return {dg, dM, dK, shares};
}

function _strategyForFirm(f, segParams){
  if (!segParams || !segParams.dark) return f.params;
  if (segParams.darkTarget && segParams.darkTarget!==f.name) return f.params;
  return segParams.dark;
}

function series(){
  const visYears=YEARS.filter(y=>y<=visibleEnd);
  const out={};
  const bpYears=Object.keys(breakpoints).map(Number).sort((a,b)=>a-b);

  firms.forEach(f=>{
    const baseRev = _baseRevenueMNOK(f.name);
    let rev = baseRev.slice(0);
    const baseMarginArr = _baseMarginPct(f.name);
    let mcur = (baseMarginArr && baseMarginArr.length? baseMarginArr[0]: 8.0);
    const startYear = 2020;
    let cursorStart = Math.max(2025, startYear + baseRev.length);
    while (rev.length < (cursorStart - startYear)) rev.push(rev[rev.length-1]);

    function extendSegment(segStartYear, segEndYear, segParams, isLive){
      const macro = isLive ? macroNow() : segParams.macro;
      const d0    = isLive ? (f.name===selectedFirmName ? darkNow() : f.params) : _strategyForFirm(f, segParams);

      for (let y=segStartYear; y<=segEndYear; y++){
        const offset = y - segStartYear;
        const strat = _strategyDelta(d0, macro, offset);
        const {D, D_eff} = _macroDC(macro, strat.shares.pub);
        const z_glob = _s01(macro.globalEconomy!=null? macro.globalEconomy:5);
        const T = 0.005 * z_glob;
        const lagFactor = _clamp(offset/2, 0, 1);
        const s_tech = _s01(d0["Teknologi"]||6);
        const dM_tech = 0.003 * Math.max(0, s_tech) * lagFactor;

        // Årlig tillväxt: bas + strategi + makro (intl-vikt ligger i strat.dg)
        const g_eff = (G0 + strat.dg) + D_eff + T;
        const prevRev = rev[rev.length-1];
        const nextRev = Math.max(0, prevRev * (1 + g_eff));
        rev.push(nextRev);

        // Marginal: p.e.-uppdatering med prispress vid negativ D
        const pressure = 0.5 * Math.abs(Math.min(0, D));
        mcur = _clamp(mcur + strat.dM + dM_tech - pressure, M0_FLOOR, M0_CEIL);
      }
    }

    let segStart = cursorStart;
    for (let i=0;i<bpYears.length && segStart<=visibleEnd;i++){
      const segEnd = Math.min(bpYears[i], visibleEnd);
      if (segEnd>=segStart){
        extendSegment(segStart, segEnd, breakpoints[bpYears[i]], false);
        segStart = segEnd + 1;
      }
    }
    if (segStart<=visibleEnd){ extendSegment(segStart, visibleEnd, null, true); }

    const yearsOut = YEARS.filter(y=>y<=visibleEnd);
    let arrOut=[];
    if (currentMetric==='revenue'){
      arrOut = rev.slice(0, yearsOut.length - (startYear-2020));
      if (useIndex) arrOut = toIndex2020(arrOut);
    } else if (currentMetric==='profit'){
      // Bygg marginalserie parallellt för projektionen för att beräkna vinst
      let margFull = [];
      let mtmp = (baseMarginArr && baseMarginArr.length? baseMarginArr[0]: 8.0);
      const baseYearsCount = (cursorStart - startYear);
      for (let i=0;i<baseYearsCount;i++) margFull.push(mtmp);
      function replaySegment(segStartYear, segEndYear, segParams, isLive){
        const macro = isLive ? macroNow() : segParams.macro;
        const d0    = isLive ? (f.name===selectedFirmName ? darkNow() : f.params) : _strategyForFirm(f, segParams);
        for (let y=segStartYear; y<=segEndYear; y++){
          const offset = y - segStartYear;
          const strat = _strategyDelta(d0, macro, offset);
          const {D} = _macroDC(macro, strat.shares.pub);
          const z_glob = _s01(macro.globalEconomy!=null? macro.globalEconomy:5);
          const T = 0.005 * z_glob;
          const lagFactor = _clamp(offset/2, 0, 1);
          const s_tech = _s01(d0["Teknologi"]||6);
          const dM_tech = 0.003 * Math.max(0, s_tech) * lagFactor;
          const pressure = 0.5 * Math.abs(Math.min(0, D));
          mtmp = _clamp(mtmp + strat.dM + dM_tech - pressure, M0_FLOOR, M0_CEIL);
          margFull.push(mtmp);
        }
      }
      segStart = cursorStart;
      for (let i=0;i<bpYears.length && segStart<=visibleEnd;i++){
        const segEnd = Math.min(bpYears[i], visibleEnd);
        if (segEnd>=segStart){ replaySegment(segStart, segEnd, breakpoints[bpYears[i]], false); segStart = segEnd + 1; }
      }
      if (segStart<=visibleEnd){ replaySegment(segStart, visibleEnd, null, true); }

      const baseProfit = _baseProfitMNOK(f.name).slice(0);
      let prof = baseProfit.slice(0);
      while (prof.length < rev.length){
        const idx = prof.length;
        const rMNOK = rev[idx];
        const mpp = (idx < margFull.length) ? margFull[idx] : mtmp;
        prof.push(Math.max(0, rMNOK * (mpp/100)));
      }
      arrOut = prof.slice(0, yearsOut.length);
      if (useIndex) arrOut = toIndex2020(arrOut);
    } else { // margin
      let marg = [];
      let mtmp = (baseMarginArr && baseMarginArr.length? baseMarginArr[0]: 8.0);
      const baseYearsCount = (cursorStart - startYear);
      for (let i=0;i<baseYearsCount;i++) marg.push(mtmp);
      function replaySegment(segStartYear, segEndYear, segParams, isLive){
        const macro = isLive ? macroNow() : segParams.macro;
        const d0    = isLive ? (f.name===selectedFirmName ? darkNow() : f.params) : _strategyForFirm(f, segParams);
        for (let y=segStartYear; y<=segEndYear; y++){
          const offset = y - segStartYear;
          const strat = _strategyDelta(d0, macro, offset);
          const {D} = _macroDC(macro, strat.shares.pub);
          const z_glob = _s01(macro.globalEconomy!=null? macro.globalEconomy:5);
          const T = 0.005 * z_glob;
          const lagFactor = _clamp(offset/2, 0, 1);
          const s_tech = _s01(d0["Teknologi"]||6);
          const dM_tech = 0.003 * Math.max(0, s_tech) * lagFactor;
          const pressure = 0.5 * Math.abs(Math.min(0, D));
          mtmp = _clamp(mtmp + strat.dM + dM_tech - pressure, M0_FLOOR, M0_CEIL);
          marg.push(mtmp);
        }
      }
      segStart = cursorStart;
      for (let i=0;i<bpYears.length && segStart<=visibleEnd;i++){
        const segEnd = Math.min(bpYears[i], visibleEnd);
        if (segEnd>=segStart){ replaySegment(segStart, segEnd, breakpoints[bpYears[i]], false); segStart = segEnd + 1; }
      }
      if (segStart<=visibleEnd){ replaySegment(segStart, visibleEnd, null, true); }
      arrOut = marg.slice(0, yearsOut.length);
    }

    out[f.name] = arrOut;
  });

  return {data: out, years: visYears};
}/* ---- Rita ---- */
function draw(){
  const titleEl=document.getElementById('chartTitle');
  let label;
  if (currentMetric==='revenue') label = useIndex ? 'Omsetningsutvikling' : 'Omsetning';
  else if (currentMetric==='profit') label = useIndex ? 'Resultatutvikling' : 'Resultat';
  else label = 'Marginer';
  if (titleEl){
    if (currentMetric==='margin') titleEl.textContent = `${label} 2020-${visibleEnd} (%)`;
    else if (useIndex) titleEl.textContent = `${label} 2020-${visibleEnd} (indeks 2020=100)`;
    else titleEl.textContent = `${label} 2020-${visibleEnd} (MNOK)`;
  }
  if (statsTitleEl){
    statsTitleEl.textContent = `${currentMetric==='revenue'?'Omsetning':currentMetric==='profit'?'Resultat':'Marginer'} ${visibleEnd} · Prognose`;
}
  const svg=chart; svg.innerHTML=''; const w=svg.clientWidth, h=svg.clientHeight; const padL=50,padR=20,padT=30,padB=74; const plotW=w-padL-padR, plotH=h-padT-padB;
  const seriesRes = series(); const S = seriesRes.data; const visYears = seriesRes.years;
  // Autoskalér y basert på synlige selskaper
  let min=Infinity, max=-Infinity, any=false;
  firms.forEach(f=>{ if(visible[f.name]){ const a=S[f.name]; if(!a) return; any=true; min=Math.min(min,...a); max=Math.max(max,...a); } });
  if(!any){ Object.values(S).forEach(a=>{ min=Math.min(min, ...a); max=Math.max(max, ...a); }); }
  let yMin,yMax,step;
  if (currentMetric==='margin'){
    yMin=Math.floor(min);
    yMax=Math.ceil(max);
    step=Math.max(1, Math.round((yMax-yMin)/6));
  } else if (useIndex){
  // Snäpp botten till 5-intervall, toppen till närmaste 50 för att få etiketter som 2050
  yMin = Math.floor((min - 5)/5)*5;
  yMax = Math.ceil((max + 5)/50)*50;
  // Välj grövre steg för max ~6 etiketter
  const range = yMax - yMin;
  const candidates = [50,100,200,250,500,1000];
  let chosen = candidates[candidates.length - 1];
  for (const s of candidates){
    const ticks = Math.floor(range / s) + 1;
    if (ticks <= 6){ chosen = s; break; }
  }
  step = chosen;
  // Snäpp botten/toppen till steget för jämna etiketter
  yMin = Math.floor(yMin/step)*step;
  yMax = Math.ceil(yMax/step)*step;
} else {
    const niceStep=(range)=>{ const rough=Math.max(range/6,1e-6); const pow=Math.pow(10, Math.floor(Math.log10(rough))); const rem=rough/pow; const m = rem<=1?1:rem<=2?2:rem<=5?5:10; return m*pow; };
    step = niceStep(max-min);
    yMin = Math.floor(min/step)*step;
    yMax = Math.ceil(max/step)*step;
  }
  const x=i=>padL+(i/Math.max(1,(visYears.length-1)))*plotW; const y=v=>padT+(1-(v-yMin)/(yMax-yMin))*plotH; const formatY = (v)=> (currentMetric==='margin' ? `${v}%` : (!useIndex ? Math.round(v).toLocaleString('no-NO') : v));
  for(let gy=yMin; gy<=yMax; gy+=step){
    const line=document.createElementNS("http://www.w3.org/2000/svg","line"); line.setAttribute("x1",padL); line.setAttribute("x2",padL+plotW); line.setAttribute("y1",y(gy)); line.setAttribute("y2",y(gy)); line.setAttribute("stroke","#2a2d36"); line.setAttribute("stroke-width","0.5"); svg.appendChild(line);
    const text=document.createElementNS("http://www.w3.org/2000/svg","text"); text.setAttribute("x",padL-8); text.setAttribute("y",y(gy)+4); text.setAttribute("fill","#9aa0aa"); text.setAttribute("font-size","10"); text.setAttribute("text-anchor","end"); text.textContent = formatY(gy); svg.appendChild(text);
  }
  // Breakpoint linjer uten hover-sletting
  const bpYears=Object.keys(breakpoints).map(Number).sort((a,b)=>a-b); const latestVisibleBP=bpYears.filter(y=>y<=visibleEnd).slice(-1)[0];
  bpYears.forEach(bpY=>{const idx=visYears.indexOf(bpY); if(idx===-1) return; const g=document.createElementNS("http://www.w3.org/2000/svg","g"); g.setAttribute("data-bp",bpY);
    const line=document.createElementNS("http://www.w3.org/2000/svg","line"); line.setAttribute("x1",x(idx)); line.setAttribute("x2",x(idx)); line.setAttribute("y1",padT); line.setAttribute("y2",padT+plotH); line.setAttribute("stroke","#4ecdc4"); line.setAttribute("stroke-width","0.6"); g.appendChild(line);
    const label=document.createElementNS("http://www.w3.org/2000/svg","text"); label.setAttribute("x",x(idx)+3); label.setAttribute("y",padT-5); label.setAttribute("fill","#4ecdc4"); label.setAttribute("font-size","10"); label.setAttribute("font-weight","bold"); label.textContent="BP "+bpY; g.appendChild(label);
    svg.appendChild(g);
  });
  const splitYear = latestVisibleBP ?? 2025; const splitIdx = visYears.indexOf(splitYear);
  firms.forEach(f=>{
    if(f.name===selectedFirmName || !visible[f.name]) return; const arr=S[f.name];
    if (splitIdx>=0){ const p1=document.createElementNS("http://www.w3.org/2000/svg","path"); let d1=`M ${x(0)} ${y(arr[0])}`; for(let i=1;i<=splitIdx;i++) d1+=` L ${x(i)} ${y(arr[i])}`; p1.setAttribute("d",d1); p1.setAttribute("fill","none"); p1.setAttribute("stroke",f.color); p1.setAttribute("stroke-width","1.2"); p1.setAttribute("opacity","0.35"); svg.appendChild(p1);} 
    if (splitIdx < arr.length-1){ const p2=document.createElementNS("http://www.w3.org/2000/svg","path"); let d2=`M ${x(Math.max(0,splitIdx))} ${y(arr[Math.max(0,splitIdx)])}`; for(let i=Math.max(1,splitIdx+1); i<arr.length; i++) d2+=` L ${x(i)} ${y(arr[i])}`; p2.setAttribute("d",d2); p2.setAttribute("fill","none"); p2.setAttribute("stroke",f.color); p2.setAttribute("stroke-width","1.2"); p2.setAttribute("opacity","0.35"); p2.setAttribute("stroke-dasharray","6,4"); svg.appendChild(p2);} 
  });
  const darkFirm=firms.find(f=>f.name===selectedFirmName); if(darkFirm && visible[darkFirm.name]){ const arr=S[darkFirm.name];
    const glow=document.createElementNS("http://www.w3.org/2000/svg","path"); let dG=`M ${x(0)} ${y(arr[0])}`; for(let i=1;i<arr.length;i++) dG+=` L ${x(i)} ${y(arr[i])}`; glow.setAttribute("d",dG); glow.setAttribute("fill","none"); glow.setAttribute("stroke",darkFirm.color); glow.setAttribute("stroke-width","8"); glow.setAttribute("opacity","0.3"); glow.setAttribute("filter","blur(8px)"); svg.appendChild(glow);
    if(splitIdx>=0){ const p1=document.createElementNS("http://www.w3.org/2000/svg","path"); let d1=`M ${x(0)} ${y(arr[0])}`; for(let i=1;i<=splitIdx;i++) d1+=` L ${x(i)} ${y(arr[i])}`; p1.setAttribute("d",d1); p1.setAttribute("fill","none"); p1.setAttribute("stroke",darkFirm.color); p1.setAttribute("stroke-width","3"); svg.appendChild(p1);} 
    if(splitIdx < arr.length-1){ const p2=document.createElementNS("http://www.w3.org/2000/svg","path"); let d2=`M ${x(Math.max(0,splitIdx))} ${y(arr[Math.max(0,splitIdx)])}`; for(let i=Math.max(1,splitIdx+1); i<arr.length; i++) d2+=` L ${x(i)} ${y(arr[i])}`; p2.setAttribute("d",d2); p2.setAttribute("fill","none"); p2.setAttribute("stroke",darkFirm.color); p2.setAttribute("stroke-width","3"); p2.setAttribute("stroke-dasharray","6,4"); svg.appendChild(p2);} }
  // X-axis, draw year labels and baseline
  visYears.forEach((year, i) => {
    const tx = document.createElementNS("http://www.w3.org/2000/svg","text");
    tx.setAttribute("x", x(i));
    tx.setAttribute("y", padT + plotH + 24);
    tx.setAttribute("fill", "#9aa0aa");
    tx.setAttribute("font-size", "10");
    tx.setAttribute("text-anchor", "middle");
    tx.textContent = year;
    svg.appendChild(tx);
  });
  const xLine = document.createElementNS("http://www.w3.org/2000/svg","line");
  xLine.setAttribute("x1", padL);
  xLine.setAttribute("x2", padL + plotW);
  xLine.setAttribute("y1", padT + plotH);
  xLine.setAttribute("y2", padT + plotH);
  xLine.setAttribute("stroke", "#2a2d36");
  xLine.setAttribute("stroke-width", "0.6");
  svg.appendChild(xLine);
  updateStats(S, visYears);
}

/* __ARS__ resize hooks inserted */
try{
  window.addEventListener('resize', ()=>{ requestAnimationFrame(draw); });
  const _cp = document.querySelector('.chart-panel');
  if (window.ResizeObserver && _cp){ new ResizeObserver(()=>{ requestAnimationFrame(draw); }).observe(_cp); }
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ()=>{ setTimeout(draw, 0); });
  } else { setTimeout(draw, 0); }
}catch(e){}

function updateStats(S, visYears){
  const stats = document.getElementById('stats-content');
  const lastIdx = visYears.length - 1;
  
  const ranked = firms.map(f=>{
    const vals = S[f.name] || [];
    const current = vals[lastIdx] ?? 0;
    const prevIdx = lastIdx - 1;
    const prev = prevIdx>=0 ? (vals[prevIdx] ?? 0) : 0;
    const change = prev ? (current - prev)/prev*100 : 0;
    return {f, current, change: +change.toFixed(1)};
  }).sort((a,b)=> b.current - a.current).slice(0,8);
  const itemHTML = (obj, idx) => {
    const {f, current, change} = obj;
    const color = change >= 0 ? '#4ecdc4' : '#ff6b6b';
    const unit = currentMetric==='margin' ? '%' : (!useIndex ? ' MNOK' : '');
    const valText = currentMetric==='margin' ? current.toFixed(1) : (!useIndex ? Math.round(current).toLocaleString('no-NO') : current.toFixed(1));
    return `
      <div style="padding:6px 0;border-bottom:1px solid #2a2d36;font-size:11px;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div style="display:flex;align-items:center;gap:8px;">
            <span class="rank-badge">${idx+1}</span>
            <span style="color:${f.name===selectedFirmName?'var(--accent)':'var(--text)'};font-weight:${f.name===selectedFirmName?600:400}">${f.name}</span>
          </div>
          <span style="color:${color};font-weight:600">${change>=0?'↑':'↓'}${Math.abs(change).toFixed(1)}%</span>
        </div>
        <div style="display:flex;justify-content:space-between;margin-top:2px;">
          <span style="color:var(--muted);font-size:10px">${visYears[lastIdx]}: ${valText}${unit}</span>
          <span style="color:var(--muted);font-size:10px">${visYears[lastIdx-1]!==undefined? ("Fra "+visYears[lastIdx-1]) : "Fra –"}</span>
        </div>
      </div>`;
  };
  const colA = ranked.slice(0,4).map((obj, i)=> itemHTML(obj, i)).join('');
  const colB = ranked.slice(4,8).map((obj, i)=> itemHTML(obj, i+4)).join('');
  stats.innerHTML = `<div class="stats-grid"><div>${colA}</div><div>${colB}</div></div>`;
}
// Init
refreshBPSelect();
(function init(){ populateFirmSelect(); setSelectedFirm(selectedFirmName); draw(); try{ if (typeof draw==='function') draw(); }catch(e){}
})();

/* ---- Proff.no overrides: real margins 2020–2024 for selected firms (safe) ---- */
(function(){
  try {
    const overrides = {
      "DARK Arkitekter AS": [13.8, 4.8, -4.7, 2.3, 1.2],
      "Arkitema AS": [12.8, 2.4, 5.8, 3.3, -0.4],
      "Jensen & Skodvin Arkitektkontor AS": [37.5, 13.8, 21.9, 16.5, 11.4],
      "Ghilardi+Hellsten Arkitekter AS": [15.6, 13.2, -5.0, -7.5, -2.7]
    };
    if (typeof MARGIN_PCT !== "undefined" && typeof REVENUE_ABS_MNOK !== "undefined" && typeof PROFIT_ABS_MNOK !== "undefined") {
      Object.entries(overrides).forEach(([name, arr])=>{
        if(!MARGIN_PCT[name]) return;
        for (let i=0; i<arr.length; i++) {
          MARGIN_PCT[name][i] = arr[i];
          const rev = (REVENUE_ABS_MNOK[name] && REVENUE_ABS_MNOK[name][i]) ? REVENUE_ABS_MNOK[name][i] : 0;
          if (!PROFIT_ABS_MNOK[name]) PROFIT_ABS_MNOK[name] = [];
          PROFIT_ABS_MNOK[name][i] = +(rev*arr[i]/100).toFixed(1);
        }
      });
    }
  } catch(e) {}
try{ if (typeof draw==='function') draw(); }catch(e){}
})();
try{ if (typeof draw==='function') draw(); }catch(e){}
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const tips = {
    rate: "Høyere rente demper etterspørsel og øker prispresse på marginer, sterkere effekt i privatmarkedet.",
    cycle: "Syklisk etterspørsel, høye nivåer løfter omsetning, lave øker prispress. Følsomheten øker med internasjonalisering.",
    publicSpend: "Økte offentlige investeringer løfter etterspørselen i offentlig segment og demper konjunkturens svingninger.",
    materials: "Høyere inputpriser kjøler etterspørsel og trekker kostnader opp, kan presse marginer ned.",
    sustainReq: "Strammere krav belønner kontor med sterk bærekraft, men kan øke kostnader i markedet generelt.",
    techBreak: "Gjennombrudd kan løfte etterspørsel og redusere kostnader noe, særlig for kontor med høy intern teknologi.",
    regLevel: "Mer regulering demper etterspørsel svakt og øker administrative kostnader.",
    globalEconomy: "Langsiktig trendløft eller -demping, legges til basetilveksten, ikke den sykliske konjunkturen.",
    pFin: "Sterk relasjon og salgsarbeid driver omsetning, med noe marginløft. Mer følsomt i konjunkturopp- og -nedgang.",
    pTal: "Høy kapasitet og kompetanse øker leveranseevne og vekst, med liten marginforbedring.",
    pTech: "Øker produktivitet og kvalitet, kostnader først opp så ned, samspiller med talent og høye bærekraftkrav.",
    pInv: "Bedre differensiering og pris, effekt fases inn over ca. to år etter beslutning.",
    pSus: "Støtter pris/kvalitet og etterspørsel når kravene er høye, svakere effekt når krav er lave.",
    pPub: "Mer offentlig inntekt demper volatilitet, men gir noe lavere margin i snitt.",
    pPriv: "Mer privat inntekt gir litt høyere trendvekst og margin, men større konjunkturfølsomhet.",
    pInt: "Større marked og høyere syklisk følsomhet, sterkere opp- og nedturer."
  };
  Object.entries(tips).forEach(([id, text]) => {
    const el = document.getElementById(id);
    if (el) el.title = text;
  });
});
</script>
<script>
(function(){
  const tips = {
    // Makro
    rate: "Høyere rente demper etterspørsel og øker prispresse på marginer, sterkere effekt i privatmarkedet.",
    cycle: "Syklisk etterspørsel, høye nivåer løfter omsetning, lave øker prispress. Følsomheten øker med internasjonalisering.",
    publicSpend: "Økte offentlige investeringer løfter etterspørselen i offentlig segment og demper konjunkturens svingninger.",
    materials: "Høyere inputpriser kjøler etterspørsel og trekker kostnader opp, kan presse marginer ned.",
    sustainReq: "Strammere krav belønner kontor med sterk bærekraft, men kan øke kostnader i markedet generelt.",
    techBreak: "Gjennombrudd kan løfte etterspørsel og redusere kostnader noe, særlig for kontor med høy intern teknologi.",
    regLevel: "Mer regulering demper etterspørsel svakt og øker administrative kostnader.",
    globalEconomy: "Påvirker den langsiktige trenden i vekst. Legges til basetilveksten hvert år, i tillegg til konjunkturer.",
    // Strategi
    pFin: "Sterke kunderelasjoner og godt salgsarbeid driver vekst direkte, med lite marginløft.",
    pTal: "Øker leveranseevne og vekst direkte, alltid. Liten men stabil marginaleffekt.",
    pTech: "Øker produktivitet og kvalitet. Kostnader først opp, deretter ned. Gir et lite marginalpåslag over tid.",
    pInv: "Skaper differensiering og bedre pris, fases gradvis inn (ca. to år).",
    pSus: "Støtter pris og etterspørsel, men særlig når miljøkravene er høye. Liten effekt når krav er lave.",
    pPub: "Mer offentlig inntekt demper volatilitet, men gir noe lavere margin i snitt.",
    pPriv: "Mer privat inntekt gir litt høyere trendvekst og margin, men større konjunkturfølsomhet.",
    pInt: "Større marked og høyere syklisk følsomhet, sterkere opp- og nedturer."
  };
  function setTip(id, text){
    const el = document.getElementById(id);
    if (!el) return;
    const ctrl = el.closest ? el.closest('.control') : null;
    // Set on input
    el.setAttribute('title', text);
    // Set on label's first span that is not the value bubble
    if (ctrl){
      const lbl = ctrl.querySelector('label span:not(.value-bubble)');
      if (lbl) lbl.setAttribute('title', text);
      // Also set on the wrapper to maximize hit area
      ctrl.setAttribute('title', text);
    }
  }
  function applyTips(){
    Object.entries(tips).forEach(([id, text]) => setTip(id, text));
  }
  // Apply now and after DOM mutations (UI updates)
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', applyTips, {once:true});
  } else {
    applyTips();
  }
  const obs = new MutationObserver(() => applyTips());
  obs.observe(document.body, {subtree:true, childList:true});
try{ if (typeof draw==='function') draw(); }catch(e){}
})();
</script>

<style id="arskp-styles">
  /* Scoped overlay styles, prefixed to prevent collisions */
  #arskp-overlay{position:fixed;inset:0;z-index:999999;display:flex;align-items:center;justify-content:center;background:rgba(11,12,16,0.94);backdrop-filter:blur(4px)}
  .arskp-panel{background:linear-gradient(135deg,#14151b,#1a1b22);border:1px solid #20222b;border-radius:14px;padding:28px;box-shadow:0 8px 24px rgba(0,0,0,.35);max-width:920px;width:clamp(320px,88vw,920px);color:#e5e7eb;font-family:Inter,system-ui,-apple-system,sans-serif}
  .arskp-badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid #2a2d36;border-radius:999px;background:#0d0e12;font-size:11px;color:#9aa0aa;margin-bottom:12px}
  .arskp-title{font-weight:800;letter-spacing:.2px;font-size:clamp(32px,6vw,64px);line-height:1.1;margin-bottom:8px}
  .arskp-sub{font-size:clamp(12px,2.2vw,16px);color:#9aa0aa;font-style:italic;margin-bottom:22px}
  .arskp-actions{display:flex;gap:12px;flex-wrap:wrap}
  .arskp-btn{cursor:pointer;background:#0d0e12;border:1px solid #2a2d36;color:#e5e7eb;border-radius:10px;padding:12px 16px;font-size:13px;font-weight:600;transition:.2s;display:inline-flex;align-items:center;justify-content:center;text-decoration:none}
  .arskp-btn:hover{border-color:#4BA3F2;background:#1a1b22}
  .arskp-btn-primary{background:#4BA3F2;border-color:#4BA3F2;color:#0b0c10}
  .arskp-btn-primary:hover{filter:brightness(1.08);box-shadow:0 8px 18px rgba(75,163,242,.25),0 0 0 4px rgba(75,163,242,.2)}
  .arskp-foot{margin-top:18px;color:#9aa0aa;font-size:12px}
  .arskp-hidden{display:none !important}
  .arskp-about h1{font-size:clamp(22px,3.8vw,36px);margin:0 0 12px 0}
  .arskp-about p,.arskp-about li{font-size:15px;line-height:1.6;color:#e5e7eb}
  .arskp-about em{color:inherit;font-style:italic}
  .arskp-about ul{margin:8px 0 0 18px}
  .arskp-toprow{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
</style>

<div id="arskp-overlay" role="dialog" aria-modal="true">
  <section class="arskp-panel" id="arskp-landing">
    <div class="arskp-badge">ArkSim</div>
    <h1 class="arskp-title">ArkSim Pro*</h1>
    <p class="arskp-sub">*Dette er en alfa, en svært tidlig testversjon. Bruk den til å leke med scenarier, men forvent feil og uferdige deler. Tallene er på liksom, men innsiktene kan være reelle. Om du vil.</p>
    <div class="arskp-actions">
      <button class="btn btn-primary" id="arskp-open">Åpne simulator</button>
      <button class="btn" id="arskp-about-btn">Om verktøyet</button>
    </div>
  </section>

  

<section class="arskp-panel arskp-hidden arskp-about" id="arskp-about">
  <div class="arskp-toprow">
    <h1>Om verktøyet</h1>
    <div class="arskp-actions">
      <button class="btn" id="arskp-back">Til start</button>
      <button class="btn btn-primary" id="arskp-open2">Åpne simulator</button>
    </div>
  </div>

  <p><em>ArkSim er en oppdiktet, pedagogisk simulator. Den bruker enkle, lineære antakelser for å illustrere hvordan interne valg (strategi) og ytre forhold (makro &amp; politikk) kan påvirke et arkitektkontors økonomi. Resultatene har ingen prognoseverdi. Enkelte av parameterne er løst inspirert av PESTEL-rammeverket, men uten å dekke alle dimensjonene fullt ut.</em></p>
  <p><strong>Om kontor-vektingen:</strong> Hvert kontor har forhåndsinnstilte nivåer for innovasjon, teknologi,
  kapasitet, salg, bærekraft og offentlig/privat-mix. Disse er grove, kvalitative anslag basert på offentlige
  beskrivelser av porteføljer, størrelse og internasjonalisering. De er ikke fasit og brukes kun for å variere
  startforutsetninger mellom kontorer.</p>


  <h2>Formål</h2>
  <p>Målet er å gjøre økonomiske sammenhenger <strong>synlige</strong> uten å gjøre modellen komplisert. Du skal kunne eksperimentere med scenarier, forstå spenninger mellom kapasitet, teknologi, innovasjon og marked, og diskutere konsekvenser – uten å bruke modellen som beslutningsgrunnlag.</p>

  <h2>Teoretisk grunnlag (kort)</h2>
  <ul>
    <li><strong>Mikro/bedriftsteori</strong>: Inntekter (etterspørsel × pris) påvirkes av salgsarbeid, kapasitet/kompetanse og differensiering (innovasjon). Kostnader deles grovt i faste (lønn/drift) og variable (prosjektavhengige).</li>
    <li><strong>Marginaltenkning</strong>: Teknologi og prosessforbedring øker kostnad først (investering/innføring), men senker marginalkost på sikt.</li>
    <li><strong>Makro</strong>: Rente, inflasjon og konjunktur forplanter seg i byggemarkedet (investeringsvilje) og lønns-/materialkost.</li>
    <li><strong>Risikoprofil</strong>: Offentlig/privat-mix brukes som proxy for volatilitet (offentlig demper svingninger, privat forsterker).</li>
  </ul>

  <h2>Modellarkitektur i appen</h2>
  <ul>
    <li><strong>Input</strong>: Skyveknapper for <em>Strategi</em> og <em>Makro &amp; politikk</em>; valgte regler lagres via <em>breakpoints</em> per år.</li>
    <li><strong>Kjerneberegning</strong>: For hvert år beregnes vekst i omsetning og kostnadsdrift i prosentpoeng. Margin% utledes fra forholdet mellom kostnad og omsetning, med små premie-/straffetillegg fra strategi/interaksjoner.</li>
    <li><strong>Output</strong>: Kurver for omsetning, resultat og margin; indeks (2020=100) kan slås av/på for å vise MNOK.</li>
  </ul>

  <div style="margin:10px 0 14px 0;padding:10px 12px;background:#10131a;border:1px solid #2a2d36;border-radius:10px">
    <div style="font-weight:700;margin-bottom:6px">Forenklede formler</div>
    <pre style="white-space:pre-wrap;line-height:1.6"><code>
Omsetningₜ₊₁ = Omsetningₜ × (1 + gₜ/100)
Kostnadₜ₊₁   = Kostnadₜ   × (1 + cₜ/100)
Resultatₜ    = Omsetningₜ − Kostnadₜ
Margin%ₜ     = 100 × (1 − Kostnadₜ / Omsetningₜ)

gₜ = g_base + g_makro + g_strategi + g_interaksjoner + g_tek
cₜ = c_base + c_makro + c_strategi + c_interaksjoner + c_tek
    </code></pre>
  </div>

  <h2>Mapping av parametre</h2>
  <ul>
    <li><strong>Kunder og salg</strong>: +vekst (flere muligheter/bedre hit‑rate), liten kostnadsøkning, liten marginpremie for realisering.</li>
    <li><strong>Talent og kapasitet</strong>: høyere utnyttelse ⇒ potensiell marginopp; faste kostnader opp.</li>
    <li><strong>Teknologi</strong>: <em>lagg</em> (år 1 kost opp og margin litt ned; år 2+ kost ned), liten vekstboost.</li>
    <li><strong>Innovasjon</strong>: +vekst, liten kostopp, liten marginpremie; samspill med teknologi kan gi ekstra premie.</li>
    <li><strong>Bærekraft/kompetanse</strong>: kan delvis nøytralisere kostnadsdrag fra strengere miljøkrav.</li>
    <li><strong>Offentlig/privat andel</strong>: justerer konjunktur- og renterisiko (offentlig demper, privat forsterker).</li>
    <li><strong>Konjunktur</strong>: ± på vekst; dempet av høy offentlig andel.</li>
    <li><strong>Rente</strong>: høyere rente trekker vekst ned, særlig for privat andel.</li>
    <li><strong>Material/byggekost</strong>: trekker kostnadsindeks opp; reduserer også salgs‑/veksteffekt noe.</li>
    <li><strong>Regulering/miljøkrav</strong>: kortsiktig kost opp; liten positiv etterspørselseffekt mulig over tid.</li>
    <li><strong>Offentlige investeringer</strong>: +vekst, sterkere effekt ved høy offentlig andel.</li>
    <li><strong>Global økonomi/teknologi</strong>: små justeringer via internasjonalisering og teknologiberedskap.</li>
  </ul>

  <h2>Interaksjoner og demping</h2>
  <ul>
    <li><strong>Offentlig × (konjunktur, rente)</strong>: lavere amplitude i gₜ.</li>
    <li><strong>Bærekraft × miljøkrav</strong>: delvis kompensasjon i cₜ.</li>
    <li><strong>Materialkost × salg</strong>: reduserer effekt av høy “Kunder og salg”.</li>
    <li><strong>Teknologi × innovasjon</strong>: liten ekstra marginpremie.</li>
  </ul>

  <h2>Begrensninger</h2>
  <ul>
    <li>Lineære effekter (pedagogikk fremfor realisme), tak/gulv på margin, ingen stokastikk.</li>
    <li>Kun valgt kontor påvirkes direkte av strategi; øvrige følger makro + sin profil.</li>
    <li>Data er syntetiske; ikke bruk som beslutningsstøtte.</li>
  </ul>

  <h2>Tips</h2>
  <ul>
    <li>Start med “Normal” makro, test én strategivariabel av gangen.</li>
    <li>Bruk <em>breakpoints</em> for å dele opp fremtiden i “perioder” (f.eks. innføring av teknologi → oppskalering).</li>
    <li>Veksle mellom indeks og MNOK for å se både relative og absolutte utslag.</li>
  </ul>
</section>


</div>
<script id="arskp-script">
  (function(){
    var $ = function(id){ return document.getElementById(id); };
    var overlay = $("arskp-overlay");
    if(!overlay) return;
    var landing = $("arskp-landing");
    var about = $("arskp-about");
    var open1 = $("arskp-open");
    var open2 = $("arskp-open2");
    var aboutBtn = $("arskp-about-btn");
    var back = $("arskp-back");

    function showAbout(){
      landing.classList.add("arskp-hidden");
      about.classList.remove("arskp-hidden");
    }
    function showLanding(){
      about.classList.add("arskp-hidden");
      landing.classList.remove("arskp-hidden");
    }
    function openSim(){
      // Simply hide the overlay, revealing the untouched simulator underneath
      overlay.style.display = "none";
    }
    if(aboutBtn) aboutBtn.addEventListener("click", showAbout);
    if(back) back.addEventListener("click", showLanding);
    if(open1) open1.addEventListener("click", openSim);
    if(open2) open2.addEventListener("click", openSim);
  try{ if (typeof draw==='function') draw(); }catch(e){}
})();
</script>

<!-- ==== ArkSim overlay (mobile/small screen) ==== -->
<style>
  .as-ol{ position:fixed; inset:0; background:rgba(13,14,18,0.94); color:#e8e9ef;
          display:flex; align-items:center; justify-content:center; z-index:999999;
          padding:24px; text-align:center; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif; }
  .as-ol.hidden{ display:none !important; }
  .as-ol .as-ol-card{ max-width:640px; width:min(92ch, 92vw); background:#0d0e12; border:1px solid #2a2d36;
                      border-radius:12px; padding:20px 18px; box-shadow:0 10px 30px rgba(0,0,0,0.45); }
  .as-ol h2{ margin:0 0 10px 0; font-size:18px; line-height:1.4; font-weight:700; letter-spacing:.2px; }
  .as-ol p{ margin:6px 0 14px 0; font-size:14px; line-height:1.6; color:#b9bcc8; }
  .as-ol .as-ol-actions{ display:flex; gap:10px; justify-content:center; }
  
</style>
<div id="as-ol" class="as-ol hidden" role="dialog" aria-modal="true" aria-labelledby="as-ol-title">
  <div class="as-ol-card">
    <h2 id="as-ol-title">ArkSim er ikke optimalisert for mobil eller små skjermer.</h2>
    <p>Sitter du på PC, forstørr gjerne vinduet.</p>
    <div class="as-ol-actions">
      <button id="as-ol-continue" class="btn btn-primary" type="button">Fortsett likevel</button>
    </div>
  </div>
</div>
<script>
(function(){
  
  const el = document.getElementById("as-ol");
  const btn = document.getElementById("as-ol-continue");

  function isMobileUA(){
    const ua = navigator.userAgent || "";
    return /(Mobi|Android|iPhone|iPad|iPod|Tablet|IEMobile|Kindle|Silk|PlayBook|BB10)/i.test(ua);
  }
  function isWindowTiny(){
    const w = window.innerWidth || document.documentElement.clientWidth || 0;
    const h = window.innerHeight || document.documentElement.clientHeight || 0;
    return (w < 980) || (h < 640);
  }
  function shouldShow(){
    if (isMobileUA()) return true;
    return isWindowTiny();
  }
  function show(){ if(el) el.classList.remove("hidden"); }
  function hide(){ if(el) el.classList.add("hidden"); }

  if (btn){
    btn.addEventListener("click", function(){
      hide();
    });
  }

  function refreshOverlay(){
    if (shouldShow()){ show(); }
    else { hide(); }
  }

  document.addEventListener("DOMContentLoaded", refreshOverlay);
  window.addEventListener("resize", function(){
    refreshOverlay();
  });
})();</script>

<!-- ==== End ArkSim overlay ==== -->

<script>
(function(){
  function $q(sel){ return document.querySelector(sel); }
  function addInlineAbout(){
    var panel = document.querySelector('.panel.controls-panel');
    if(!panel) return;
    if(document.getElementById('arskp-about-btn-inline')) return;
    var cta = document.createElement('div');
    cta.className = 'about-cta';
    cta.innerHTML = '<button class="btn" 

<script>
(function(){
  function addInlineAboutLink(){
    var panel = document.querySelector('.panel.controls-panel');
    if(!panel) return;
    if(document.getElementById('arskp-about-link-inline')) return;
    var link = document.createElement('a');
    link.id = 'arskp-about-link-inline';
    link.className = 'about-link-inline';
    link.textContent = 'Om verktøyet';
    link.href = '#';
    link.addEventListener('click', function(e){
      e.preventDefault();
      var overlay = document.getElementById('arskp-overlay');
      var landing = document.getElementById('arskp-landing');
      var about = document.getElementById('arskp-about');
      if(overlay && landing && about){
        overlay.style.display = 'flex';
        landing.classList.add('arskp-hidden');
        about.classList.remove('arskp-hidden');
      }
    });
    panel.appendChild(link);
  }
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', addInlineAboutLink, {once:true});
  } else {
    addInlineAboutLink();
  }
})();
</script>

<script>
(function(){
  function bindAboutLink(){
    var link = document.getElementById('arskp-about-link-inline');
    if(!link) return;
    link.addEventListener('click', function(e){
      e.preventDefault();
      var overlay = document.getElementById('arskp-overlay');
      var landing = document.getElementById('arskp-landing');
      var about = document.getElementById('arskp-about');
      if(overlay && landing && about){
        overlay.style.display = 'flex';
        landing.classList.add('arskp-hidden');
        about.classList.remove('arskp-hidden');
      }
    });
  }
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', bindAboutLink, {once:true});
  } else {
    bindAboutLink();
  }
})();
</script>

;


<script>
/* __ARS__ mobile gate v2 */
(function(){
  try{
    function isTouchPointer(){ try { return matchMedia('(pointer: coarse)').matches; } catch(e){ return false; } }
    function isMobileUA(){
      var ua = (navigator.userAgent||'').toLowerCase();
      var isIOS = /iphone|ipod|ipad/.test(ua) || (navigator.platform==='MacIntel' && navigator.maxTouchPoints>1);
      var isAndroid = /android/.test(ua);
      return isIOS || isAndroid;
    }
    var shouldGate = isTouchPointer() || isMobileUA();
    if(!shouldGate) return;
    if(!document.getElementById('arskp-landing')){
      var ov = document.createElement('div');
      ov.id = 'arskp-landing';
      ov.style.position = 'fixed';
      ov.style.inset = '0';
      ov.style.background = 'rgba(11,12,16,0.98)';
      ov.style.zIndex = '99999';
      ov.style.display = 'flex';
      ov.style.alignItems = 'center';
      ov.style.justifyContent = 'center';
      ov.innerHTML = '<div class="panel arskp-panel" style="max-width:540px;text-align:center;">'
        + '<div class="arskp-title" style="font-size:18px;margin-bottom:8px;">Ikke optimalisert for mobil/nettbrett</div>'
        + '<div class="arskp-sub" style="font-size:14px;color:var(--muted);margin-bottom:16px;">*Dette er en alfa, en svært tidlig testversjon. Bruk den til å leke med scenarier, men forvent feil og uferdige deler. Tallene er på liksom, men innsiktene kan være reelle. Om du vil.</div>'
        + '<div class="arskp-actions" style="display:flex;gap:12px;justify-content:center;">'
        + '<button id="arskp-continue" class="btn" style="padding:10px 14px;font-weight:600;">Fortsett likevel</button>'
        + '<button id="arskp-cancel" class="btn" style="padding:10px 14px;">Avbryt</button>'
        + '</div>'
        + '</div>';
      document.body.appendChild(ov);
      var cont = document.getElementById('arskp-continue');
      var canc = document.getElementById('arskp-cancel');
      if (cont) cont.addEventListener('click', function(){ ov.remove(); });
      if (canc) canc.addEventListener('click', function(){ location.href = 'about:blank'; });
    } else {
      var l = document.getElementById('arskp-landing');
      l.style.display = 'flex';
    }
  }catch(e){}
})();
</script>

</body>
</html>